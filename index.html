/* ==========================================================
   Portfolio One-Page (Marco Servidio)
   Modifiche incluse:
   - Branding & contenuti personalizzati
   - Progetti reali (Medico Sereno, Askhole, Programma Ricami)
   - Integrazione form con Formspree + "copia email"
   ========================================================== */

document.addEventListener('DOMContentLoaded', () => {
  // ----- Preloader -----
  window.addEventListener('load', () => {
    const pre = document.getElementById('preloader');
    pre?.classList.add('hidden');
    setTimeout(() => pre?.remove(), 500);
  });

  // ----- Year in footer -----
  document.getElementById('year').textContent = new Date().getFullYear();

  // ----- Mobile nav toggle -----
  const navToggle = document.getElementById('navToggle');
  const navMenu = document.getElementById('navMenu');
  navToggle?.addEventListener('click', () => {
    const open = navMenu.classList.toggle('open');
    navToggle.setAttribute('aria-expanded', String(open));
  });
  document.querySelectorAll('.nav-link').forEach(a =>
    a.addEventListener('click', () => navMenu.classList.remove('open'))
  );

  // ----- Smooth scroll -----
  document.querySelectorAll('a[href^="#"]').forEach(link => {
    link.addEventListener('click', e => {
      const id = link.getAttribute('href');
      if (id && id.length > 1) {
        const target = document.querySelector(id);
        if (target) {
          e.preventDefault();
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          history.pushState(null, '', id);
          if (!target.hasAttribute('tabindex')) target.setAttribute('tabindex', '-1');
          target.focus({ preventScroll: true });
        }
      }
    });
  });

  // ----- Scrollspy -----
  const sections = [...document.querySelectorAll('section[id]')];
  const navLinks = [...document.querySelectorAll('.nav-link')];
  const spy = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      const id = entry.target.getAttribute('id');
      const link = navLinks.find(a => a.getAttribute('href') === `#${id}`);
      if (entry.isIntersecting) {
        navLinks.forEach(a => a.classList.remove('active'));
        link?.classList.add('active');
      }
    });
  }, { rootMargin: '-40% 0px -50% 0px', threshold: 0.01 });
  sections.forEach(s => spy.observe(s));

  // ----- AOS (tiny) -----
  const aosEls = document.querySelectorAll('.aos');
  const aos = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const delay = e.target.getAttribute('data-aos-delay') || 0;
        setTimeout(() => e.target.classList.add('in'), Number(delay));
        aos.unobserve(e.target);
      }
    });
  }, { threshold: 0.12 });
  aosEls.forEach(el => aos.observe(el));

  // ----- Typewriter rotating -----
  const phrases = ["Sviluppatore Web", "UI/UX Designer", "Creatore di Soluzioni Digitali"];
  const twEl = document.querySelector('.typewriter');
  const typingSpeed = 70, pause = 1200, eraseSpeed = 45;
  let idx = 0, char = 0, typing = true;
  function tick() {
    const word = phrases[idx % phrases.length];
    if (typing) {
      twEl.textContent = word.slice(0, ++char);
      if (char === word.length) { typing = false; return setTimeout(tick, pause); }
    } else {
      twEl.textContent = word.slice(0, --char);
      if (char === 0) { typing = true; idx++; }
    }
    setTimeout(tick, typing ? typingSpeed : eraseSpeed);
  }
  if (twEl) tick();

  // ----- Project Modal -----
  const PROJECTS = {
    p1: {
      title: "Medico Sereno",
      desc: "Gestionale medico: pazienti, appuntamenti, cartelle cliniche e fatturazione. Migrazione da desktop (Tkinter) a web.",
      bullets: [
        "Obiettivi: UX per studi medici, sicurezza dati e backup.",
        "Sfide: conformità normativa italiana e performance.",
        "Ruolo: architettura, sviluppo full-stack e UI/UX."
      ],
      live: "#",   // TODO: link demo se disponibile
      git: "#"     // TODO: link repo
    },
    p2: {
      title: "Askhole",
      desc: "App mobile di chat AI con personalità sarcastica; modello freemium, backend Flask.",
      bullets: [
        "Obiettivi: intrattenimento e viralità social.",
        "Sfide: moderazione contenuti e scalabilità API.",
        "Ruolo: UX, Flutter client, integrazione AI."
      ],
      live: "#",   // TODO
      git: "#"     // TODO
    },
    p3: {
      title: "Programma Ricami",
      desc: "Gestione lotti, taglie, workflow di ricamo e generazione PDF di produzione.",
      bullets: [
        "Obiettivi: flusso rapido dalla scelta file alla selezione prodotti.",
        "Sfide: coerenza taglie tra PDF e UI, usabilità operatori.",
        "Ruolo: design UX e sviluppo front-end/back-end."
      ],
      live: "#",   // TODO
      git: "#"     // TODO
    }
  };

  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalDesc = document.getElementById('modal-desc');
  const modalList = document.getElementById('modal-list');
  const modalLive = document.getElementById('modal-live');
  const modalGit = document.getElementById('modal-git');

  function openModal(id) {
    const data = PROJECTS[id];
    if (!data) return;
    modalTitle.textContent = data.title;
    modalDesc.textContent = data.desc;
    modalList.innerHTML = '';
    data.bullets.forEach(b => {
      const li = document.createElement('li'); li.textContent = b; modalList.appendChild(li);
    });
    modalLive.href = data.live || '#';
    modalGit.href = data.git || '#';
    modal.hidden = false;
    document.body.style.overflow = 'hidden';
    modal.querySelector('.modal-close').focus();
  }
  function closeModal() {
    modal.hidden = true; document.body.style.overflow = '';
  }
  document.querySelectorAll('.open-modal').forEach(btn => {
    btn.addEventListener('click', () => openModal(btn.dataset.project));
  });
  modal.addEventListener('click', e => { if (e.target.dataset.close === 'true') closeModal(); });
  document.addEventListener('keydown', e => { if (!modal.hidden && e.key === 'Escape') closeModal(); });

  // ----- Contact form (Formspree) -----
  /*
    Come usare:
    1) Crea un form su https://formspree.io/ e prendi l'endpoint (es. /f/abcdwxyz)
    2) Sostituisci FORMSPREE_ENDPOINT qui sotto.
  */
  const FORMSPREE_ENDPOINT = "https://formspree.io/f/XXXXYYYY"; // TODO: incolla il tuo endpoint
  const form = document.getElementById('contactForm');
  const statusEl = document.getElementById('form-status');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = form.name.value.trim();
    const email = form.email.value.trim();
    const message = form.message.value.trim();
    let ok = true;

    // Validazione base + messaggi
    const setErr = (input, msg='') => {
      const field = input.closest('.form-field');
      const err = field.querySelector('.error');
      err.textContent = msg;
      if (msg) ok = false;
    };
    setErr(form.name); setErr(form.email); setErr(form.message);

    if (!name) setErr(form.name, 'Inserisci il tuo nome.');
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
    if (!emailRe.test(email)) setErr(form.email, 'Email non valida.');
    if (!message) setErr(form.message, 'Scrivi un messaggio.');

    if (!ok) return;

    // Invio a Formspree
    try {
      statusEl.textContent = 'Invio in corso...';
      const res = await fetch(FORMSPREE_ENDPOINT, {
        method: 'POST',
        headers: { 'Accept': 'application/json' },
        body: new FormData(form)
      });
      if (res.ok) {
        statusEl.textContent = 'Grazie! Ti risponderò al più presto.';
        form.reset();
      } else {
        statusEl.textContent = 'Ops! Qualcosa è andato storto. Puoi scrivermi direttamente via email.';
      }
    } catch {
      statusEl.textContent = 'Connessione assente o bloccata. Riprova più tardi.';
    }
  });

  // ----- Copia email -----
  const copyBtn = document.getElementById('copyEmail');
  const emailLink = document.getElementById('emailLink');
  copyBtn?.addEventListener('click', async () => {
    const email = (emailLink?.textContent || '').trim();
    try {
      await navigator.clipboard.writeText(email);
      copyBtn.textContent = 'Copiata!';
      setTimeout(() => (copyBtn.textContent = 'Copia email'), 1500);
    } catch {
      copyBtn.textContent = 'Copia non riuscita';
      setTimeout(() => (copyBtn.textContent = 'Copia email'), 1500);
    }
  });

  // ----- Canvas Constellation -----
  const canvas = document.getElementById('constellation');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    let w, h, particles, mouse = { x: null, y: null };

    function resize() {
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      w = canvas.clientWidth; h = canvas.clientHeight;
      canvas.width = w * dpr; canvas.height = h * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      initParticles();
    }
    function initParticles() {
      const count = Math.floor((w * h) / 10000);
      particles = Array.from({ length: count }, () => ({
        x: Math.random() * w,
        y: Math.random() * h,
        vx: (Math.random() - .5) * .4,
        vy: (Math.random() - .5) * .4,
        r: Math.random() * 1.8 + .6
      }));
    }
    function draw() {
      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = 'rgba(255,255,255,.8)';
      for (const p of particles) {
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill();
      }
      for (let i = 0; i < particles.length; i++) {
        for (let j = i + 1; j < particles.length; j++) {
          const p = particles[i], q = particles[j];
          const dx = p.x - q.x, dy = p.y - q.y;
          const dist2 = dx * dx + dy * dy;
          if (dist2 < 120 * 120) {
            const alpha = 1 - dist2 / (120 * 120);
            const grad = ctx.createLinearGradient(p.x, p.y, q.x, q.y);
            grad.addColorStop(0, `rgba(0,123,255,${alpha * .6})`);
            grad.addColorStop(1, `rgba(23,162,184,${alpha * .6})`);
            ctx.strokeStyle = grad; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(q.x, q.y); ctx.stroke();
          }
        }
      }
      update();
      requestAnimationFrame(draw);
    }
    function update() {
      for (const p of particles) {
        if (mouse.x !== null) {
          const dx = mouse.x - p.x, dy = mouse.y - p.y;
          const d = Math.hypot(dx, dy);
          if (d < 140) { p.vx += dx / d * 0.02; p.vy += dy / d * 0.02; }
        }
        p.x += p.vx; p.y += p.vy;
        if (p.x < 0 || p.x > w) p.vx *= -1;
        if (p.y < 0 || p.y > h) p.vy *= -1;
        p.vx *= 0.99; p.vy *= 0.99;
      }
    }
    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      mouse.x = e.clientX - rect.left; mouse.y = e.clientY - rect.top;
    });
    canvas.addEventListener('mouseleave', () => { mouse.x = mouse.y = null; });
    window.addEventListener('resize', resize, { passive: true });

    resize(); draw();
  }
});
